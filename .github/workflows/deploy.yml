name: Deploy Java Backend

on:
  push:
    branches: [ "master" ] # ‚ö†Ô∏è Confirma si tu rama es 'master' o 'main'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------------------
      # 1. PREPARACI√ìN (GitHub)
      # ----------------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # ----------------------------------------------------------------
      # 2. COMPILACI√ìN (Usando los servidores de GitHub)
      # ----------------------------------------------------------------
      - name: Build with Maven
        # Saltamos tests (-DskipTests) para que el primer deploy sea r√°pido y seguro
        run: ./mvnw clean package -DskipTests

      - name: Rename JAR
        # Renombramos el archivo complejo a 'app.jar' para facilitar la vida a Docker
        run: mv target/ms-resume-*.jar target/app.jar

      # ----------------------------------------------------------------
      # 3. TRANSFERENCIA (Hacia Hetzner)
      # ----------------------------------------------------------------
      - name: Copy JAR via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          # Copiamos solo el JAR nuevo y el Dockerfile
          source: "target/app.jar,Dockerfile"
          target: "/root/deploy/ms-resume"
          strip_components: 1

      # ----------------------------------------------------------------
      # 4. DESPLIEGUE (Reinicio remoto)
      # ----------------------------------------------------------------
      - name: Restart Java Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          script: |
            echo "üöÄ Recibido nuevo JAR. Desplegando..."
            
            cd /root/deploy
            
            # Ajuste de seguridad: Si SCP dej√≥ el jar en una subcarpeta, lo movemos
            if [ -f ms-resume/target/app.jar ]; then
               mv ms-resume/target/app.jar ms-resume/app.jar
               rm -rf ms-resume/target
            fi
            
            # Reconstruir SOLO el servicio Java (Docker detectar√° el cambio de archivo)
            docker compose up -d --build ms-resume
            
            # Limpiar im√°genes viejas para ahorrar espacio
            docker image prune -f
            
            echo "‚úÖ Backend actualizado con √©xito."